# Потоки

* Если не подождать поток в плюсах, то по завершении главного треда, все потоки будут убиты
* Если в Java не подождать поток (не сделать `join`), то JVM всех подождёт после завершения главного потока
* При посылке сигнала процессу, обрабатывать этот сигнал (если есть обработчик) будет какой-то поток! Это не определено. Можно использовать маскирование SIG_MASK, чтобы обратиться к конкретному потоку, видимо.

## Прерывание потока 

### POSIX Pthread

* Создатель потока (вызвавший `create`) дёргает метод `cancel` на потоке
* `cancel` выставляет флаг `flag` у целевого потока ля прерывания
* Целевой поток периодически вызывает функцию `test_cancel` (а может и никогда)
* Когда `test_cancel` обнаружил, что поток хотят убить, то он бежит по стеку `cleanup` функций и дёргает их... (регистрируются они `cleanup_push`, `cleanup_pop`)
* Почти все системные `glibc` функции являются `cancellation point`, т.е. они в своём теле хоть раз дёргают `test_cancel` вызвавшего их потока
* Существует механизм для запрета `cancel` на потоке, это нужно для того, чтобы поток не завершили во время важной операции, например, `write()`, т.к. он `cancellation point`.
* Суть: механизм завершения потока работает так, что интерфеса для жёсткого завершения не предоставляется, в замен этого можно сказать потоку: "завершись, пожалуйста", а он уже сам решает, что с этим сделать


### Завершение потоков Java

* Идеологически `InterruptException`, а точнее методы, которые его кидают, являются `cancellation points`. Они, правда, `interruption points`
* Нельза сделать так, чтобы операция была не завершаемой (not interruptible) на какое-то, нужное нам, время (в posix можно)

### С++

* В Boost есть interrupt
* В C++11 нету механизма прерывания

## Ресурсы

* Point: нет никакой связи между ресурсом и связанным с ним примитивом синхронизации (это проблема...кажется)

## Исключения

Как узнать, что случилось с потоком, т.е. какое исключение в нём возникло?

* В Java `cause` у `Future` и у исключения там есть всякие методы...
* В C++ появился `exception_ptr` (когда-то)

## Синхронизация потоков
